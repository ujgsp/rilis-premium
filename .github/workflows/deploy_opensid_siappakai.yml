name: Midnight Deploy SiapPakai OpenSID with Ansible

on:
  schedule:
    # - cron: '0 17 * * *' # 00:00 WIB
    - cron: '0 5 * * *'    # 12:00 WIB
    - cron: '15 6 * * *'   # 13:15 WIB
    - cron: '0 13 * * *'   # 20:00 WIB
    - cron: '30 13 * * *'  # 20:30 WIB
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: deploy-opensid-siappakai-rilis
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Check for pending release
        id: pending
        run: |
          if [ -f .github/PENDING_RELEASE ]; then
            echo "Found pending release marker"
            cat .github/PENDING_RELEASE
            
            TAG=$(jq -r '.tag' .github/PENDING_RELEASE)
            
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "✅ Will deploy ${TAG}"
          else
            echo "No pending release found. Skipping deploy."
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy OpenSID ${{ steps.pending.outputs.tag }}
        if: steps.pending.outputs.deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.CICD_SERVER_VPN_IP }}
          username: ${{ secrets.CICD_SERVER_VPN_USER }}
          key: ${{ secrets.CICD_SERVER_VPN_PRIVATE_KEY }}
          port: ${{ secrets.CICD_SERVER_VPN_PORT }}
          script: |
            set -euo pipefail
            cd ${{ secrets.CICD_SERVER_VPN_PATH }}
            
            echo "Deploying OpenSID version ${{ steps.pending.outputs.tag }}"

            ansible-playbook -i inventories/staging/inventory.yml playbooks/test_api_remote.yml

            echo "Deployment started."

      - name: Clear pending release marker
        if: steps.pending.outputs.deploy == 'true'
        run: |
          if [ -f .github/PENDING_RELEASE ]; then
            TAG=$(jq -r '.tag' .github/PENDING_RELEASE)
            BRANCH="${{ github.event.repository.default_branch }}"
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            rm .github/PENDING_RELEASE
            git add .github/PENDING_RELEASE
            git commit -m "Clear release marker after deploying ${TAG}"
            git push origin HEAD:${BRANCH}
            
            echo "✅ Pending release marker cleared"
          else
            echo "No marker file to clear"
          fi
